---
title: "R Figures"
output:
  pdf_document:
  toc: yes
html_document:
  code_folding: hide
fig_height: 6
fig_width: 8
highlight: pygments
theme: cosmo
toc: yes
toc_float: yes
word_document:
  toc: yes
always_allow_html: yes
---
  
```{r setup, include=FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org"))
if(!require(tidyverse)){install.packages("tidyverse")}
library(tidyverse)
if(!require(tidyverse)){install.packages("ggplot2")}
library(ggplot2)
if(!require(car)){install.packages("car")}
library(car)
if(!require(lme4)){install.packages("lme4")}
library(lme4)
if(!require(psych)){install.packages("psych")}
library(psych)
if(!require(directlabels)){install.packages("directlabels")}
library(directlabels)
if(!require(lavaan)){install.packages("lavaan")}
library(lavaan)
if(!require(lavaan)){install.packages("semPlot")}
library(semPlot)
```

# Import the data

```{r}
# Import the longtable with all results
lt <- read.csv(file="total_longtable.csv")
# Separate out results for RQ2 and RQ3 
lt_RQ2 <- lt[lt$initial_visualizations == 1,]
lt_RQ3 <- lt[lt$initial_visualizations == 0,]
```


## Aggregating scores
We aggregate the longtable scores for comprehension, trust, and operationalized 
bias across all questions per participant to get their totals for every person.

```{r}
lt_RQ2_aggregate <- lt_RQ2 %>%
  group_by(Pid, Vis_Type, qualitative_model_perception, Gender, Age, 
           Familiarity) %>%
  summarise(
    comprehension = sum(comprehension),
    trust = sum(trust),
    likert.only.trust=sum(likert.only.trust),
    bias.operational = sum(bias.operational),
    correct.output = sum(correct.output),
    correct.pushing = sum(correct.pushing),
    correct.power = sum(correct.power),
    .groups = "drop" 
  )
```

# Mediation model

We fit a mediation model with trust score as the dependent variable, the 
comprehension score as the predictor, and the bias perception score as 
the mediator. We find that comprehension has a direct positive effect on 
bias perception, and bias perception had a direct negative effect on trust.
That is, increased comprehension indirectly decreases trust by impacting 
perception of bias. 
```{r}

mediation_model <- '
  # Mediator equation: effect of comprehension on the mediator (bias percep.)
  bias.operational ~ a * comprehension

  # Outcome equation: direct effect of comprehension and effect of the 
  # mediator (bias percep.) on trust
  trust ~ c_prime * comprehension + b * bias.operational

  # Indirect effect: the mediation path (a * b)
  indirect := a * b

  # Total effect: sum of the direct and indirect effects
  total := c_prime + indirect
'

# Estimate the mediation model
mediation_results <- sem(mediation_model, data = lt_RQ2_aggregate)

# Summarize the results
summary(mediation_results, standardized = TRUE, fit.measures = TRUE)

```

We plot this mediation model below.

```{r}
plot = semPaths(mediation_results, whatLabels = "est", style = "lisrel", 
                nCharNodes=0,sizeMan=12, label.cex=1, sizeInt = 7, 
                edge.label.cex=1, posCol='green', negCol='red',  
                nodeLabels=c("Perceived Bias", "Trust Score", "Comp. Score"))
```

We also plot the distributions of each measure

```{r}

ggplot(lt_RQ2_aggregate, aes(comprehension)) +
  ggtitle("Aggregate Comprehension Score") + 
  geom_histogram(bins=25) + 
  ylim(0, 150) +
  xlim(0, 45) + 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(text = element_text(size = 20))+
  labs(x = "", y="# Participants")

ggplot(lt_RQ2_aggregate, aes(bias.operational)) +
  ggtitle("Aggregate Perceived Bias Score") + 
  geom_histogram(bins=25) + 
  ylim(0, 50) +
  xlim(0, 25) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(text = element_text(size = 20))+
  labs(x = "", y="# Participants")

ggplot(lt_RQ2_aggregate, aes(trust)) +
  ggtitle("Aggregate Trust Score") + 
  geom_histogram(bins=25) + 
  ylim(0, 50) +
  xlim(0, 105)+ 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(text = element_text(size = 20))+
  labs(x = "", y="# Participants")

```

# Figure 1

We plot the comprehension, bias perception and trust measures to be able to 
create figure 1

Setup
```{r}
options(repr.plot.height=20)
lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == "shap") ~ "SHAP Waterfall", .default = Vis_Type))
         
lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == 'lime') ~ "LIME", .default = Vis_Type))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == 'forceshap') ~ "SHAP Force", .default = Vis_Type))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == 'eli5') ~ "ELI5", .default = Vis_Type))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == 'cp') ~ "Ceteris Paribus", .default = Vis_Type))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(Vis_Type = case_when((Vis_Type == 'anchors') ~ "Anchors", .default = Vis_Type))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == "SHAP Waterfall") ~ 3, .default = 0))
         
lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == 'LIME') ~ 5, .default = leastmost))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == 'SHAP Force') ~ 6, .default = leastmost))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == 'ELI5') ~ 4, .default = leastmost))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == 'Ceteris Paribus') ~ 1, .default = leastmost))

lt_RQ2_aggregate <- lt_RQ2_aggregate %>%
  mutate(leastmost = case_when((Vis_Type == 'Anchors') ~ 2, .default = leastmost))
```

Comprehension 
```{r}
lt_RQ2_aggregate %>% ggplot(aes(x = comprehension, y = reorder(Vis_Type, leastmost), color=Vis_Type)) +
  stat_summary(geom = "point", shape=108, fun.x = "mean", size = 30) +
  geom_jitter(width=0.08) +
  labs(
    title = "",
    x = "",
    y = ""
  ) + 
  scale_y_discrete(name ="") +
  theme_bw() + 
  theme(legend.key = element_blank(), strip.background = element_rect(colour="white", fill="white")) + 
  theme(strip.text.y.left = element_text(angle = 0) ) + 
  theme(legend.position = "none") +
  labs(x = "") + 
  scale_x_continuous(breaks = seq(0, 45, by = 5)) +
  theme(panel.grid.minor = element_blank(), panel.border = element_blank(), axis.text.y=element_blank(),axis.ticks.y=element_blank()) 
  ggsave(file="p2.png", width=7, height=16)
```

Bias Perception  
```{r}
lt_RQ2_aggregate %>% ggplot(aes(x = bias.operational, y = reorder(Vis_Type, leastmost), color=Vis_Type)) +
  stat_summary(geom = "point", shape=108, fun.x = "mean", size=30) +
  geom_jitter(width=0.08) +
  labs(
    title = "",
    x = "",
    y = ""
  ) + 
  scale_y_discrete(name ="") +
  theme_bw() + 
  theme(legend.key = element_blank(), strip.background = element_rect(colour="white", fill="white")) + 
  theme(strip.text.y.left = element_text(angle = 0) ) + 
  theme(legend.position = "none") +
  labs(x = "") + 
  scale_x_continuous(breaks = seq(0, 30, by = 2)) +
  theme(panel.grid.minor = element_blank(), panel.border = element_blank(), axis.text.y=element_blank(),axis.ticks.y=element_blank()) 
  ggsave(file="p3.png", width=7, height=16)
```

Trust
```{r}
lt_RQ2_aggregate %>% ggplot(aes(x = trust, y = reorder(Vis_Type, leastmost), color=Vis_Type)) +
  stat_summary(geom = "point", shape=108, fun.x = "mean", size = 30) +
  geom_jitter(width=0.08) +
  labs(
    title = "",
    x = "",
    y = ""
  ) + 
  scale_y_discrete(name ="") +
  theme_bw() + 
  theme(legend.key = element_blank(), strip.background = element_rect(colour="white", fill="white")) + 
  theme(strip.text.y.left = element_text(angle = 0) ) + 
  theme(legend.position = "none") +
  labs(x = "") + 
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  theme(panel.grid.minor = element_blank(), panel.border = element_blank(), axis.text.y=element_blank(),axis.ticks.y=element_blank()) 
  ggsave(file="p1.png", width=7, height=16)

```
